{% extends "base.html" %}

{% block content %}
<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Firebird Data Transfer (Dialect 1)</h2>
    </div>
    <div class="card-body">
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="row">
                <!-- Source DB -->
                <div class="col-md-6 border-end">
                    <h4 class="text-secondary mb-3">Source Database</h4>
                    <div class="mb-3">
                        {{ form.src_host.label(class="form-label") }}
                        {{ form.src_host(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.src_port.label(class="form-label") }}
                        {{ form.src_port(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.src_path.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.src_path(class="form-control", placeholder="e.g. C:/data/source.fdb", id="src_path") }}
                            <button type="button" class="btn btn-outline-secondary" onclick="browseFile('src_path')">Browse...</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.src_charset.label(class="form-label") }}
                        {{ form.src_charset(class="form-select") }}
                    </div>
                </div>

                <!-- Dest DB -->
                <div class="col-md-6">
                    <h4 class="text-secondary mb-3">Destination Database</h4>
                    <div class="mb-3">
                        {{ form.dst_host.label(class="form-label") }}
                        {{ form.dst_host(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.dst_port.label(class="form-label") }}
                        {{ form.dst_port(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.dst_path.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.dst_path(class="form-control", placeholder="e.g. C:/data/dest.fdb", id="dst_path") }}
                            <button type="button" class="btn btn-outline-secondary" onclick="browseFile('dst_path')">Browse...</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.dst_charset.label(class="form-label") }}
                        {{ form.dst_charset(class="form-select") }}
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <!-- Config -->
            <div class="row">
                <div class="col-12">
                    <h4 class="text-secondary mb-3">Transfer Configuration</h4>
                    <div class="mb-3">
                        {{ form.table_name.label(class="form-label") }}
                        {{ form.table_name(class="form-control") }}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                             <div class="mb-3">
                                {{ form.src_condition.label(class="form-label") }}
                                {{ form.src_condition(class="form-control") }}
                                <div class="form-text">Example: <code>ID > 1000 AND STATUS = 'ACTIVE'</code></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.check_columns.label(class="form-label") }}
                                {{ form.check_columns(class="form-control") }}
                                <div class="form-text">Comma-separated columns to prevent duplicates. E.g.: <code>ID</code> or <code>CODE, YEAR</code></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                {{ form.submit(class="btn btn-success btn-lg") }}
            </div>
        </form>

        <!-- Progress Container -->
        <div id="progress-container" class="mt-4" style="display: none;">
            <h5 id="progress-status" class="text-secondary">Initializing...</h5>
            <div class="progress mb-3" style="height: 25px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div class="alert alert-secondary d-flex justify-content-between">
                <span>Inserted: <strong id="stat-inserted">0</strong></span>
                <span>Skipped: <strong id="stat-skipped">0</strong></span>
            </div>
            <h6 class="text-muted">Log:</h6>
            <div id="log-container" class="border p-2 bg-light rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
            </div>
        </div>

    </div>
</div>

<script>
async function browseFile(inputId) {
    try {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = 'Opening...';
        btn.disabled = true;

        const response = await fetch('/browse_db');
        const data = await response.json();
        
        if (data.path) {
            document.getElementById(inputId).value = data.path;
        } else if (data.error) {
            alert('Error: ' + data.error);
        }
        
        btn.innerText = originalText;
        btn.disabled = false;
    } catch (e) {
        console.error(e);
        alert('Failed to open file dialog');
        // Restore button state in case of error
        // Note: event.target might be lost in async, but we have 'btn' captured
        if (typeof btn !== 'undefined') {
            btn.innerText = 'Browse...';
            btn.disabled = false;
        }
    }
}

document.querySelector('form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('input[type="submit"]');
    
    // UI Reset
    submitBtn.disabled = true;
    document.getElementById('progress-container').style.display = 'block';
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('progress-status');
    const logContainer = document.getElementById('log-container');
    const statInserted = document.getElementById('stat-inserted');
    const statSkipped = document.getElementById('stat-skipped');
    
    progressBar.style.width = '0%';
    progressBar.innerText = '0%';
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    logContainer.innerHTML = '';
    statInserted.innerText = '0';
    statSkipped.innerText = '0';
    
    function log(msg, type='info') {
        const div = document.createElement('div');
        div.className = type === 'error' ? 'text-danger fw-bold' : (type === 'success' ? 'text-success fw-bold' : 'text-dark');
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logContainer.appendChild(div);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    try {
        log('Starting transfer...');
        const response = await fetch('/api/transfer', {
            method: 'POST',
            body: formData
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop(); // Keep the last incomplete line
            
            for (const line of lines) {
                if (!line.trim()) continue;
                try {
                    const data = JSON.parse(line);
                    
                    if (data.status === 'info') {
                        log(data.message);
                        statusText.innerText = data.message;
                        if (data.total) {
                             statusText.innerText += ` (Total: ${data.total})`;
                        }
                    } else if (data.status === 'progress') {
                        const percent = Math.round((data.current / data.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressBar.innerText = percent + '%';
                        statInserted.innerText = data.inserted;
                        statSkipped.innerText = data.skipped;
                        statusText.innerText = `Processing... ${data.current}/${data.total}`;
                    } else if (data.status === 'completed') {
                        log(data.message, 'success');
                        statusText.innerText = 'Completed';
                        progressBar.className = 'progress-bar bg-success';
                        progressBar.style.width = '100%';
                        progressBar.innerText = '100%';
                        statInserted.innerText = data.inserted;
                        statSkipped.innerText = data.skipped;
                    } else if (data.status === 'error') {
                        log('Error: ' + data.message, 'error');
                        statusText.innerText = 'Error occurred';
                        progressBar.className = 'progress-bar bg-danger';
                        alert('Error: ' + data.message);
                    }
                } catch (err) {
                    console.error('JSON Parse Error:', err, line);
                }
            }
        }
    } catch (e) {
        log('Network/System Error: ' + e.message, 'error');
        alert('System Error: ' + e.message);
    } finally {
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}
